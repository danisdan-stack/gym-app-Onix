<!-- src/app/pages/pagos/pagos.page.html -->
<ion-header>
  <ion-toolbar color="primary">
    <ion-button (click)="volverAlHome()">
      <ion-icon name="home" slot="start"></ion-icon>
      home
    </ion-button>
    <ion-title>
      <ion-icon name="cash-outline" slot="start"></ion-icon>
      Control de Pagos
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refrescar()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Resumen Estadístico -->
  <div class="stats-container">
    <ion-grid>
      <ion-row>
        <ion-col size="6" size-md="3">
          <div class="stat-card total">
            <ion-icon name="people"></ion-icon>
            <div class="stat-info">
              <h3>{{totalClientes}}</h3>
              <p>Total Clientes</p>
            </div>
          </div>
        </ion-col>
        
        <ion-col size="6" size-md="3">
          <div class="stat-card success">
            <ion-icon name="checkmark-circle"></ion-icon>
            <div class="stat-info">
              <h3>{{alDiaCount}}</h3>
              <p>Al Día</p>
            </div>
          </div>
        </ion-col>
        
        <ion-col size="6" size-md="3">
          <div class="stat-card warning">
            <ion-icon name="warning"></ion-icon>
            <div class="stat-info">
              <h3>{{retrasoLeveCount}}</h3>
              <p>Retraso Leve</p>
            </div>
          </div>
        </ion-col>
        
        <ion-col size="6" size-md="3">
          <div class="stat-card danger">
            <ion-icon name="alert-circle"></ion-icon>
            <div class="stat-info">
              <h3>{{retrasoSeveroCount}}</h3>
              <p>Retraso Severo</p>
            </div>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <!-- Filtros y Búsqueda -->
  <ion-card>
    <ion-card-content>
      <!-- Búsqueda -->
      <ion-searchbar 
        placeholder="Buscar por nombre o teléfono..." 
        (ionInput)="onSearch($event)"
        debounce="300"
        animated="true">
      </ion-searchbar>
      
      <!-- Filtros por estado -->
      <div class="filters-container">
        <ion-segment value="todos" (ionChange)="onEstadoChange($event)">
          <ion-segment-button value="todos">
            <ion-label>Todos ({{totalClientes}})</ion-label>
          </ion-segment-button>
          <ion-segment-button value="al-dia">
            <ion-label>Al Día ({{alDiaCount}})</ion-label>
          </ion-segment-button>
          <ion-segment-button value="retraso-leve">
            <ion-label>Retraso Leve ({{retrasoLeveCount}})</ion-label>
          </ion-segment-button>
          <ion-segment-button value="retraso-severo">
            <ion-label>Retraso Severo ({{retrasoSeveroCount}})</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Lista de Clientes -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="list" slot="start"></ion-icon>
        Lista de Clientes
      </ion-card-title>
      <ion-card-subtitle>
        {{filteredClientes.length}} cliente{{filteredClientes.length !== 1 ? 's' : ''}} mostrado{{filteredClientes.length !== 1 ? 's' : ''}}
      </ion-card-subtitle>
    </ion-card-header>
    
    <ion-card-content>
      <!-- Loading -->
      <div *ngIf="isLoading" class="loading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando clientes...</p>
      </div>
      
      <!-- Lista de clientes -->
      <ion-list *ngIf="!isLoading && filteredClientes.length > 0">
        <ion-item *ngFor="let cliente of filteredClientes" 
                  [class]="cliente.estado_pago + '-item'"
                  lines="full">
          <!-- Avatar -->
          <ion-avatar slot="start">
            <div class="avatar-initials">
              {{cliente.nombre?.charAt(0)}}{{cliente.apellido?.charAt(0)}}
            </div>
          </ion-avatar>
          
          <!-- Información -->
          <ion-label>
            <!-- ✅ NOMBRE COMPLETO - ARRIBA -->
            <h2 class="nombre-completo">{{cliente.nombre_completo}}</h2>
            
            <!-- ✅ NOMBRE Y APELLIDO SEPARADOS (OPCIONAL) -->
            <p class="nombre-separado" *ngIf="cliente.nombre || cliente.apellido">
              <span *ngIf="cliente.nombre"><strong></strong> {{cliente.nombre}}</span>
              <span *ngIf="cliente.nombre && cliente.apellido"> • </span>
              <span *ngIf="cliente.apellido"><strong></strong> {{cliente.apellido}}</span>
            </p>
            
            <!-- ✅ CELULAR - ABAJO DEL NOMBRE -->
          <p class="client-detail telefono">
  <ion-icon name="call-outline"></ion-icon>
  <span *ngIf="cliente.telefono" 
        (click)="abrirWhatsApp(cliente)"  
        class="whatsapp-link">
    {{cliente.telefono}}
  </span>
  <span *ngIf="!cliente.telefono" class="no-phone">
    Sin teléfono
  </span>
</p>
            
            <!-- Fecha de vencimiento -->
            <p class="client-detail">
              <ion-icon name="calendar-outline"></ion-icon>
              Vence: {{cliente.fecha_vencimiento_formatted}}
            </p>
            
            <!-- Estado -->
            <ion-badge [color]="getColorEstado(cliente.estado_pago)" class="status-badge">
              <ion-icon [name]="getIconoEstado(cliente.estado_pago)" slot="start"></ion-icon>
              {{getTextoEstado(cliente.estado_pago)}}
              <span *ngIf="cliente.dias_retraso > 0"> - {{cliente.dias_retraso}} días</span>
            </ion-badge>
          </ion-label>
          
          <!-- Acciones -->
          <ion-buttons slot="end">
            <!-- WhatsApp -->
            <ion-button *ngIf="cliente.telefono" 
                       fill="clear" 
                       size="small" 
                       color="success"
                       (click)="abrirWhatsApp(cliente)">
              <ion-icon name="logo-whatsapp"></ion-icon>
            </ion-button>
            
            <!-- Registrar Pago -->
            <ion-button fill="solid" 
                       size="small" 
                       color="primary"
                       (click)="registrarPago(cliente)">
              <ion-icon name="cash" slot="start"></ion-icon>
              Pagar
            </ion-button>
          </ion-buttons>
        </ion-item>
      </ion-list>
      
      <!-- Sin resultados -->
      <div *ngIf="!isLoading && filteredClientes.length === 0" class="empty-state">
        <ion-icon name="search-outline"></ion-icon>
        <h3>No se encontraron clientes</h3>
        <p *ngIf="searchTerm">Intenta con otros términos de búsqueda</p>
        <ion-button fill="outline" (click)="searchTerm = ''; filtroEstado = 'todos'; aplicarFiltros()">
          Limpiar filtros
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</ion-content>
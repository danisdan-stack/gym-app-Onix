<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goToDashboard()">
        <ion-icon name="home" slot="icon-only" color="medium-light"></ion-icon>
      </ion-button>
      <ion-menu-button color="medium-light"></ion-menu-button>
    </ion-buttons>
    <ion-title color="dark">Miembros</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshData()">
        <ion-icon name="refresh" slot="icon-only" color="medium-light"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando miembros...</p>
  </div>

  <!-- Error -->
  <div *ngIf="!loading && errorMessage" class="error-container">
    <ion-icon name="alert-circle" color="danger" size="large"></ion-icon>
    <h3>Error</h3>
    <p>{{errorMessage}}</p>
    <ion-button (click)="refreshData()" fill="outline" color="medium">
      Reintentar
    </ion-button>
  </div>

  <!-- Content -->
  <div *ngIf="!loading && !errorMessage">
    <!-- Search -->
    <ion-searchbar 
      placeholder="Buscar por nombre, teléfono..."
      (ionInput)="onSearchInput($event)"
      animated
      color="light"
      class="ion-margin-bottom">
    </ion-searchbar>

    <!-- Status Filter -->
    <ion-segment value="activos" (ionChange)="filterByStatus($event)" class="ion-margin-bottom" color="light">
      <ion-segment-button value="activos">
        <ion-label color="dark">Activos ({{totalActivos}})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="porVencer">
        <ion-label color="dark">Por Vencer ({{totalPorVencer}})</ion-label>
      </ion-segment-button>
      <ion-segment-button value="inactivos">
        <ion-label color="dark">Inactivos ({{totalInactivos}})</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Stats Card -->
    <ion-card class="ion-margin-bottom stats-card">
      <ion-card-content>
        <ion-grid>
          <ion-row class="stats-row">
            <ion-col size="4" class="stat-col activo">
              <ion-icon name="checkmark-circle-outline" size="large" color="success"></ion-icon>
              <h3>{{totalActivos}}</h3>
              <p>Activos</p>
            </ion-col>
            <ion-col size="4" class="stat-col por-vencer">
              <ion-icon name="time-outline" size="large" color="warning"></ion-icon>
              <h3>{{totalPorVencer}}</h3>
              <p>Por Vencer</p>
            </ion-col>
            <ion-col size="4" class="stat-col inactivo">
              <ion-icon name="close-circle-outline" size="large" color="medium"></ion-icon>
              <h3>{{totalInactivos}}</h3>
              <p>Inactivos</p>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Clients List -->
    <div *ngIf="getClientesFiltrados().length > 0">
      <ion-list class="clients-list">
        <ion-item *ngFor="let client of getClientesFiltrados()" button (click)="viewMemberDetails(client.usuario_id)" lines="full" class="client-item">
          <ion-avatar slot="start" class="client-avatar">
  <!-- Iniciales como en Pagos -->
  <div class="avatar-initials">
    {{ (client.nombre?.charAt(0) || '') + (client.apellido?.charAt(0) || '') || '?' }}
  </div>
</ion-avatar>
          
          <ion-label class="client-info">
            <div class="client-header">
              <h2 class="client-name">{{client.nombre}} {{client.apellido}}</h2>
              
              <!-- Badge principal de estado -->
              <ion-badge 
                [color]="calcularEstadoCliente(client) === 'activo' ? 'success' : 'medium'"
                class="status-badge">
                {{calcularEstadoCliente(client) === 'activo' ? 'Activo' : 'Inactivo'}}
              </ion-badge>
              
              <!-- Badge para "Por Vencer" -->
              <ion-badge 
                *ngIf="calcularEstadoCliente(client) === 'activo' && diasParaVencer(client) <= 7 && diasParaVencer(client) > 0"
                color="warning" 
                class="warning-badge">
                ⏳ Vence en {{diasParaVencer(client)}} días
              </ion-badge>
              
              <!-- Badge para "Vence Hoy" -->
              <ion-badge 
                *ngIf="calcularEstadoCliente(client) === 'activo' && diasParaVencer(client) === 0"
                color="danger" 
                class="danger-badge">
                ⚠️ Vence hoy
              </ion-badge>
              
              <!-- Badge para "Vencido" -->
              <ion-badge 
                *ngIf="calcularEstadoCliente(client) === 'inactivo' && client.fecha_vencimiento"
                color="dark" 
                class="expired-badge">
                ❌ Vencido
              </ion-badge>
            </div>
            
            <!-- WhatsApp Link -->
            <div class="client-contact">
              <a 
                [href]="generarEnlaceWhatsApp(client)" 
                target="_blank"
                (click)="$event.stopPropagation()"
                class="whatsapp-link">
                <ion-icon name="logo-whatsapp" color="success"></ion-icon>
                <span class="phone-number">{{client.telefono || 'Sin teléfono'}}</span>
              </a>
            </div>
            
            <!-- Dates -->
            <div class="client-dates">
              <span class="date-item">
                <ion-icon name="calendar" size="small" color="medium-light"></ion-icon>
                <span class="date-label">Insc:</span>
                <span class="date-value">{{formatDate(client.fecha_inscripcion)}}</span>
              </span>
              
              <span class="date-separator">•</span>
              
              <span class="date-item">
                <ion-icon name="time" size="small" color="medium-light"></ion-icon>
                <span class="date-label">Vence:</span>
                <span class="date-value">{{formatDate(client.fecha_vencimiento) || 'Sin fecha'}}</span>
              </span>
            </div>
          </ion-label>
          
          <!-- Action Buttons -->
          <div class="action-buttons" slot="end" (click)="$event.stopPropagation()">
            <!-- WhatsApp Button -->
            <ion-button 
              fill="clear" 
              size="small"
              class="action-button whatsapp-button"
              [href]="generarEnlaceWhatsApp(client)"
              target="_blank">
              <ion-icon name="logo-whatsapp" slot="icon-only" color="success"></ion-icon>
            </ion-button>
            
            <!-- Download Button -->
            <ion-button 
              fill="clear" 
              size="small"
              class="action-button download-button"
              (click)="descargarCarnet(client)">
              <ion-icon name="download-outline" slot="icon-only" color="medium"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </div>

    <!-- Empty State -->
    <div *ngIf="getClientesFiltrados().length === 0" class="empty-state">
      <div class="empty-icon">
        <ion-icon name="people-outline" size="large" color="medium-light"></ion-icon>
      </div>
      <h3 class="empty-title">No hay {{getStatusLabel(filterStatus).toLowerCase()}}</h3>
      <p class="empty-message" *ngIf="searchTerm">Intenta con otro término de búsqueda</p>
      <ion-button (click)="goToNewMember()" fill="solid" color="primary" class="empty-button">
        <ion-icon name="add" slot="start"></ion-icon>
        Nuevo Miembro
      </ion-button>
    </div>
  </div>
</ion-content>

